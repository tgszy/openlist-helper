name: Build and Push Docker Image

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'   # 严格只匹配 v1.0.0、v2.3.4，杜绝 v1、v1.2 等

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 提取触发 tag（带安全检查）
      - name: Get the tag name that triggered the workflow
        id: tag
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          echo "Triggered tag: $TAG"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          # 保险：如果不是 vX.Y.Z 格式，直接失败
          if ! [[ $TAG =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "非标准版本号 $TAG，拒绝构建！"
            exit 1
          fi

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 生成 Docker tags（修复 heredoc 语法）
      - name: Generate Docker tags
        id: docker_tags
        run: |
          VERSION=${{ steps.tag.outputs.tag }}        # 例如 v1.2.3
          CLEAN=${VERSION#v}                          # 去掉 v → 1.2.3
          MAJOR=$(echo $CLEAN | cut -d. -f1)          # 1
          MINOR=$(echo $CLEAN | cut -d. -f1-2)        # 1.2
          
          echo "版本信息：完整=$CLEAN, major=$MAJOR, minor=$MINOR"
          
          # 修复：用 cat > heredoc 生成多行 TAGS
          cat > tags.txt << EOF
          ${{ secrets.DOCKERHUB_USERNAME }}/openlist-helper:$CLEAN
          ${{ secrets.DOCKERHUB_USERNAME }}/openlist-helper:$MINOR
          ${{ secrets.DOCKERHUB_USERNAME }}/openlist-helper:$MAJOR
          ${{ secrets.DOCKERHUB_USERNAME }}/openlist-helper:latest
          EOF
          
          # 读取文件并转成逗号分隔（用于 tags 输入）
          TAGS=$(tr '\n' ',' < tags.txt | sed 's/,$//')
          echo "tags=$TAGS" >> $GITHUB_OUTPUT
          
          # 清理临时文件
          rm tags.txt
          
          # 生成 labels
          echo "labels=org.opencontainers.image.version=$CLEAN" >> $GITHUB_OUTPUT

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ steps.docker_tags.outputs.tags }}
          labels: ${{ steps.docker_tags.outputs.labels }}
